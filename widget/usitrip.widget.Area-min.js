Usitrip.ns("usitrip.widget"),usitrip.widget.Area=function(config){usitrip.widget.Area.superclass.constructor.apply(this,arguments),this.addEvents("beforerender","afterrender","countrydone","provincedone","citydone"),this.initComponent(config)},Usitrip.extend(usitrip.widget.Area,usitrip.event.UsitripEvent,{ajaxUrl:"",el:"",initValue:{data:{},country_name:"country",province_name:"province",city_name:"city",defaultCountry:{name:"请选择国家",id:"",func:$.noop},defaultProvince:{name:"州/省",id:"",func:$.noop},defaultCity:{name:"城市",id:"",func:$.noop}},initComponent:function(config){Usitrip.apply(this.initValue,config.initValue),Usitrip.apply(config.initValue,this.initValue),Usitrip.apply(this,config),this.render(this.el),this.doEvent(),this.initData()},initData:function(){this.alreadyInitData={};var country_val,province_val,c_i,c_j,p_i,p_j,findIndex=function(arr,id,obj){for(var i=0,len=arr.length;len>i;i++)for(var j=0,j_len=arr[i].list.length;j_len>j;j++)if(id==arr[i].list[j].id){obj.attr("i",i).attr("j",j),i=len;break}},initCountryData=function(){country_val=this.country_input.val(),country_val&&(this.initValue.data.hasOwnProperty("title")?(findIndex(this.initValue.data.tag,country_val,this.country_input),$.proxy(initProvinceData,this)()):this.ajax({action:"getCountry"},$.proxy(function(data,json){if(json){json.defaultId=country_val,this.show("getCountry",json,!1);try{this.initValue.data.hasOwnProperty("title")&&this.initValue.data.tag&&(findIndex(this.initValue.data.tag,country_val,this.country_input),$.proxy(initProvinceData,this)())}catch(e){throw e.getErrorMessage()}}},this)))},initProvinceData=function(){if(province_val=this.province_input.val()){if(this.showTag="J-province-tab",c_i=this.country_input.attr("i"),c_j=this.country_input.attr("j"),!this.country_input.val()||"0"==this.country_input.val())return;this.initValue.data.tag[c_i].list[c_j].hasOwnProperty("data")?(findIndex(this.initValue.data.tag[c_i].list[c_j].data.tag,province_val,this.province_input),$.proxy(initCityData,this)()):this.ajax({action:"getProvince",country_id:country_val},$.proxy(function(data,json){if(json){json.defaultId=province_val,this.show("getProvince",json,!1);try{this.initValue.data.tag[c_i].list[c_j].hasOwnProperty("data")&&this.initValue.data.tag[c_i].list[c_j].data.tag&&(findIndex(this.initValue.data.tag[c_i].list[c_j].data.tag,province_val,this.province_input),$.proxy(initCityData,this)())}catch(e){throw e.getErrorMessage()}}},this))}},initCityData=function(){var city_val=this.city_input.val();city_val&&(this.showTag="J-city-tab",c_i=this.country_input.attr("i"),c_j=this.country_input.attr("j"),p_i=this.province_input.attr("i"),p_j=this.province_input.attr("j"),this.initValue.data.tag[c_i].list[c_j].data.tag[p_i].list[p_j].hasOwnProperty("data")?findIndex(this.initValue.data.tag[c_i].list[c_j].data.tag[p_i].list[p_j].data.tag,city_val,this.city_input):this.ajax({action:"getCity",zone_id:province_val},$.proxy(function(data,json){if(json){json.defaultId=city_val,this.show("getCity",json,!1);try{this.initValue.data.tag[c_i].list[c_j].data.tag[p_i].list[p_j].hasOwnProperty("data")&&this.initValue.data.tag[c_i].list[c_j].data.tag[p_i].list[p_j].data.tag&&findIndex(this.initValue.data.tag[c_i].list[c_j].data.tag[p_i].list[p_j].data.tag,city_val,this.city_input)}catch(e){throw e.getErrorMessage()}}},this)))};$.proxy(initCountryData,this)()},render:function(el){this.fireEvent("beforerender",this)!==!1&&(this.doRender(el),this.fireEvent("afterrender"))},doRender:function(el){var content='<span class="uc-chgplace" id="ucSelectCountry"><i>'+this.initValue.defaultCountry.name+'</i><input type="hidden" name="'+this.initValue.country_name+'" value="'+this.initValue.defaultCountry.id+'"></span>\n<span class="uc-chgplace" id="ucSelectProvince"><i>'+this.initValue.defaultProvince.name+'</i><input type="hidden" name="'+this.initValue.province_name+'" value="'+this.initValue.defaultProvince.id+'"/></span>\n<span class="uc-chgplace" id="ucSelectCity"><i>'+this.initValue.defaultCity.name+'</i><input type="hidden" name="'+this.initValue.city_name+'" value="'+this.initValue.defaultCity.id+'"/></span>';content+='<div class="ucPlaceDialog J_Country" title="" style="display:none"><div class="d_hd"><a href="javascript:;" class="close J_CloseCountry">x</a><h4><span class="J-title"></span><span style="display:none;">(按名称开头字母查看，支持方向键"← →"切换字母，"↑ ↓"选择国家，首字母搜索)</span></h4></div><div class="d_cont uifix J-CountryTab"></div><div class="place_cont J-CountryCon"></div><div class="d_foot"><a href="javascript:;" class="d_btn J-okCountry">确定</a><a href="javascript:;" class="d_btn J_CloseCountry">取消</a></div></div>',$(el).html(content)},ajax:function(data,callback){var me=this;$.post(this.ajaxUrl,data,function(json){json.defaultId=data.hasOwnProperty("country_id")?data.country_id:data.hasOwnProperty("zone_id")?data.zone_id:json.defaultId,"function"==typeof callback&&$.proxy(callback,me)(data.action,json)},"json")},validation:function(data){var tmp;switch(data.action){case"getCountry":this.initValue.data.hasOwnProperty("title")&&this.initValue.data.hasOwnProperty("tag")?this.show(data.action):this.ajax(data,this.show);break;case"getProvince":var _i=this.country_input.attr("i"),_j=this.country_input.attr("j");if(!isNaN(_i)&&!isNaN(_j))try{tmp=this.initValue.data.tag[_i].list[_j],tmp.hasOwnProperty("data")&&tmp.data.hasOwnProperty("title")&&tmp.data.hasOwnProperty("tag")?this.show(data.action):this.ajax(data,this.show)}catch(e){}break;case"getCity":var c_i=this.country_input.attr("i"),c_j=this.country_input.attr("j"),p_i=this.province_input.attr("i"),p_j=this.province_input.attr("j");if(!(isNaN(c_i)||isNaN(c_j)||isNaN(p_i)||isNaN(p_j)))try{tmp=this.initValue.data.tag[c_i].list[c_j].data.tag[p_i].list[p_j],tmp.hasOwnProperty("data")&&tmp.data.hasOwnProperty("title")&&tmp.data.hasOwnProperty("tag")?this.show(data.action):data.zone_id&&this.ajax(data,this.show)}catch(e){}}},doEvent:function(){var el=this.el;this.areaWrap=$(el).find(".J_Country"),this.country=$(el).find("#ucSelectCountry"),this.province=$(el).find("#ucSelectProvince"),this.city=$(el).find("#ucSelectCity"),this.closeBtn=$(el).find(".J_CloseCountry"),this.title=$(el).find(".J-title"),this.dCountryTab=$(el).find(".J-CountryTab"),this.dCountryCon=$(el).find(".J-CountryCon"),this.j_ok=$(el).find(".J-okCountry"),this.country_input=$(el).find('input[name="'+this.initValue.country_name+'"]'),this.province_input=$(el).find('input[name="'+this.initValue.province_name+'"]'),this.city_input=$(el).find('input[name="'+this.initValue.city_name+'"]'),this.areaWrap.click(function(event){event.stopPropagation()}),this.country.click($.proxy(function(event){this.hide(),this.showTag="J-country-tab",this.validation({action:"getCountry"}),event.stopPropagation()},this)),this.province.click($.proxy(function(event){this.hide(),this.showTag="J-province-tab";var cid=this.country_input.val();this.validation({action:"getProvince",country_id:cid}),event.stopPropagation()},this)),this.city.click($.proxy(function(event){this.hide(),this.showTag="J-city-tab";var cid=this.province_input.val();this.validation({action:"getCity",zone_id:cid}),event.stopPropagation()},this)),this.closeBtn.click($.proxy(function(event){this.hide(),event.stopPropagation()},this)),this.j_ok.click($.proxy(function(event){this.hide();var tmp,i,j,pi,pj;switch(this.showTag){case"J-country-tab":tmp=this.areaWrap.find('input[name="'+this.showTag+'_opt"]:checked'),tmp.length>0&&(tmp.val()!=this.country_input.val()&&(this.province_input.val("").parent().find("i").html("州/省"),this.city_input.val("").parent().find("i").html("城市")),this.country_input.val(tmp.val()).attr("i",tmp.attr("i")).attr("j",tmp.attr("j")),this.country_input.parent().find("i").html(tmp.parents("label").text()),this.fireEvent("countrydone"));break;case"J-province-tab":i=this.country_input.attr("i"),j=this.country_input.attr("j"),tmp=this.areaWrap.find('input[name="'+this.showTag+i+j+'_opt"]:checked'),tmp.length&&(tmp.val()!=this.province_input.val()&&this.city_input.val("").parent().find("i").html("城市"),this.province_input.val(tmp.val()).attr("i",tmp.attr("i")).attr("j",tmp.attr("j")),this.province_input.parent().find("i").html(tmp.parents("label").text()),this.fireEvent("provincedone"));break;case"J-city-tab":i=this.country_input.attr("i"),j=this.country_input.attr("j"),pi=this.province_input.attr("i"),pj=this.province_input.attr("j"),tmp=this.areaWrap.find('input[name="'+this.showTag+i+j+pi+pj+'_opt"]:checked'),tmp.length&&(this.city_input.val(tmp.val()).attr("i",tmp.attr("i")).attr("j",tmp.attr("j")),this.city_input.parent().find("i").html(tmp.parents("label").text()),this.fireEvent("citydone"))}event.stopPropagation()},this));var me=this;this.dCountryTab.delegate("li","click",function(){var cls=$(this).parents("div").attr("cls"),index=$(this).parents("div").find("li").removeClass("current").index($(this));$(this).addClass("current"),me.dCountryCon.find("."+cls+" > div").hide().eq(index).show()}),$(document).click($.proxy(this.hide,this))},addData:function(tag,i,j,pi,pj){var already,selectIndex,htmlTag,htmlCon,tmp,initHtmlTab=function(arr,tagName){for(var rtn='<div class="'+tagName+'" cls="'+tagName+'"><ul class="dCountryTab">',i=0,len=arr.length;len>i;i++)rtn+="<li>"+arr[i].text+"</li>";return rtn+="</ul></div>"},initHtmlCon=function(arr,selectId,tagName){for(var rtn='<div class="'+tagName+'">',i=0,len=arr.length;len>i;i++){rtn+='<div class="dCountryLabel">';for(var j=0,j_len=arr[i].list.length;j_len>j;j++)rtn+='<label for="'+tagName+"_"+i+"_"+j+'"><input type="radio" i="'+i+'" j="'+j+'" id="'+tagName+"_"+i+"_"+j+'" name="'+tagName+'_opt" value="'+arr[i].list[j].id+'"',selectId==arr[i].list[j].id&&(selectIndex=i),rtn+="/><span>"+arr[i].list[j].text+"</span></label>";rtn+="</div>"}return rtn+="</div>"};switch(tag){case"getCountry":tmp=this.initValue.data,already=this.alreadyInitData,selectIndex=0,htmlTag=initHtmlTab(tmp.tag,this.showTag),htmlCon=initHtmlCon(tmp.tag,tmp.defaultId,this.showTag),this.dCountryTab.append(htmlTag).children().hide(),this.dCountryCon.append(htmlCon).children().hide(),already.title=tmp.title,this.dCountryTab.find("."+this.showTag).show().find("li").eq(selectIndex).addClass("current"),"undefined"==typeof tmp.defaultId||isNaN(tmp.defaultId)||this.dCountryCon.find("."+this.showTag).show().find("div").eq(selectIndex).show().find('input[value="'+tmp.defaultId+'"]').attr("checked",!0);break;case"getProvince":tmp=this.initValue.data.tag[i].list[j].data,already=this.alreadyInitData,already.Province=already.Province||[],already.Province[i]=already.Province[i]||[],already.Province[i][j]=already.Province[i][j]||{},selectIndex=0,htmlTag=initHtmlTab(tmp.tag,this.showTag+i+j),htmlCon=initHtmlCon(tmp.tag,tmp.defaultId,this.showTag+i+j),this.dCountryTab.append(htmlTag).children().hide(),this.dCountryCon.append(htmlCon).children().hide(),already.Province.title=already.Province.title||tmp.title,this.dCountryTab.find("."+this.showTag+i+j).show().find("li").eq(selectIndex).addClass("current"),"undefined"!=typeof tmp.defaultId&&this.dCountryCon.find("."+this.showTag+i+j).show().find("div").eq(selectIndex).show().find('input[value="'+tmp.defaultId+'"]').attr("checked",!0);break;case"getCity":var city_data=this.initValue.data.tag[i].list[j].data.tag[pi].list[pj].data;already=this.alreadyInitData.Province[i][j],already.City=already.City||[],already.City[pi]=already.City[pi]||[],already.City[pi][pj]=already.City[pi][pj]||{},selectIndex=0,htmlTag=initHtmlTab(city_data.tag,this.showTag+i+j+pi+pj),htmlCon=initHtmlCon(city_data.tag,city_data.defaultId,this.showTag+i+j+pi+pj),this.dCountryTab.append(htmlTag).children().hide(),this.dCountryCon.append(htmlCon).children().hide(),already.City.title=already.City.title||city_data.title,this.dCountryTab.find("."+this.showTag+i+j+pi+pj).show().find("li").eq(selectIndex).addClass("current"),"undefined"!=typeof city_data.defaultId&&this.dCountryCon.find("."+this.showTag+i+j+pi+pj).show().find("div").eq(selectIndex).show().find('input[value="'+city_data.defaultId+'"]').attr("checked",!0)}},show:function(tag,data,show){var showCountry=function(){var tmp=this.initValue.data,already=this.alreadyInitData;tmp.hasOwnProperty("title")&&!already.hasOwnProperty("title")?(this.title.html(tmp.title),this.addData(tag)):(this.title.html(already.title),this.dCountryTab.children().hide().parent().find("."+this.showTag).show(),this.dCountryCon.children().hide().parent().find("."+this.showTag).show())},showProvince=function(i,j){var tmp=this.initValue.data.tag[i].list[j].data,already=this.alreadyInitData;!tmp.hasOwnProperty("title")||already.hasOwnProperty("Province")&&"undefined"!=typeof already.Province[i]&&"undefined"!=typeof already.Province[i][j]?(this.title.html(already.Province.title),this.dCountryTab.children().hide().parent().find("."+this.showTag+i+j).show(),this.dCountryCon.children().hide().parent().find("."+this.showTag+i+j).show()):(this.title.html(tmp.title),this.addData(tag,i,j))},showCity=function(c_i,c_j,p_i,p_j){var city_data=this.initValue.data.tag[c_i].list[c_j].data.tag[p_i].list[p_j].data,already=this.alreadyInitData.Province[c_i][c_j];!city_data.hasOwnProperty("title")||already.hasOwnProperty("City")&&"undefined"!=typeof already.City[p_i]&&"undefined"!=typeof already.City[p_i][p_j]?(this.title.html(already.City.title),this.dCountryTab.children().hide().parent().find("."+this.showTag+c_i+c_j+p_i+p_j).show(),this.dCountryCon.children().hide().parent().find("."+this.showTag+c_i+c_j+p_i+p_j).show()):(this.title.html(city_data.title),this.addData(tag,c_i,c_j,p_i,p_j))};switch(tag){case"getCountry":data&&(this.initValue.data=data),$.proxy(showCountry,this)();break;case"getProvince":var _i=this.country_input.attr("i"),_j=this.country_input.attr("j");if(data&&(this.initValue.data.tag[_i].list[_j].data=data),!(this.initValue.data.tag[_i].list[_j].data.hasOwnProperty("tag")&&this.initValue.data.tag[_i].list[_j].data.tag.length>0))return this.province_input.val("").parent().find("i").html("无"),void this.city_input.val("").parent().find("i").html("无");$.proxy(showProvince,this)(_i,_j);break;case"getCity":var c_i=this.country_input.attr("i"),c_j=this.country_input.attr("j"),p_i=this.province_input.attr("i"),p_j=this.province_input.attr("j");if(data&&(this.initValue.data.tag[c_i].list[c_j].data.tag[p_i].list[p_j].data=data),!(this.initValue.data.tag[c_i].list[c_j].data.tag[p_i].list[p_j].data.hasOwnProperty("tag")&&this.initValue.data.tag[c_i].list[c_j].data.tag[p_i].list[p_j].data.tag.length>0))return void this.city_input.val("").parent().find("i").html("无");$.proxy(showCity,this)(c_i,c_j,p_i,p_j)}if(0!=show){switch(tag){case"getCountry":this.country.css({"background-color":"#09f","border-color":"#09f",color:"#fff"});break;case"getProvince":this.province.css({"background-color":"#09f","border-color":"#09f",color:"#fff"});break;case"getCity":this.city.css({"background-color":"#09f","border-color":"#09f",color:"#fff"})}$(this.el).css("position","relative"),this.areaWrap.css("z-index","10").show()}},hide:function(){$(this.el).css("position","").children("span").css({"background-color":"","border-color":"",color:""}),this.areaWrap.hide()}});